<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Gaiman Engine Playground</title>
    <meta name="Description" content="Demo of the Gaiman DSL programming language. Storytellig game engine"/>
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png"/>
    <link rel="manifest" href="./favicon/site.webmanifest"/>
    <link rel="mask-icon" href="./favicon/safari-pinned-tab.svg" color="#5bbad5"/>
    <link rel="shortcut icon" href="./favicon/favicon.ico"/>
    <meta name="msapplication-TileColor" content="#ffffff"/>
    <meta name="msapplication-config" content="./favicon/browserconfig.xml"/>
    <meta name="theme-color" content="#ffffff"/>
    <!--[if IE]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://cdn.jsdelivr.net/npm/jquery.splitter/css/jquery.splitter.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/lib/codemirror.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/combine/npm/codemirror@5.x.x/addon/search/matchesonscrollbar.css,npm/codemirror@5.x.x/addon/dialog/dialog.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/theme/seti.css" rel="stylesheet"/>
    <style>
     body {
         margin: 0;
     }
     main {
         height: calc(100vh - 27px);
     }
     iframe {
         border: none;
         display: block;
     }
     .CodeMirror {
         height: 100%;
     }
     .editor, .user_input, iframe {
         width: 100%;
         height: 100%;
     }
     .hidden {
         display: none !important;
     }
     :root {
         --tab-bg: #1d1e22;
         --tab-color: #aaaebc;
         --tab-border-color: #34363e;
         --tab-color-active: #1236f7;
     }
     .errors ul, .tabs > ul, .config ul {
         list-style: none;
         margin: 0;
         padding: 0;
     }
     .tabs > ul {
         padding: 5px 10px 0 5px;
         background: black;
         font-family: sans-serif;
         border-bottom: 2px solid grey
     }
     .tabs > ul li {
         background: var(--tab-bg);
         color: var(--tab-color);
         border-top: 3px solid var(--tab-border-color);
         border-radius: 3px 3px 0 0;
         display: inline-block;
     }
     .tabs > .content > :not(.active) {
         display: none;
     }
     .tabs > .content {
         height: calc(100% - 40px);
     }
     .tabs > ul li.active {
         border-top-color: var(--tab-color-active);
         margin-bottom: -2px;
         padding-bottom: 2px;
     }
     .tabs > ul li a, .tabs > ul li a:hover {
         color: inherit;
         display: block;
         padding: 6px 18px;
         text-decoration: none;
     }
     @media screen and (min-width: 900px) {
         iframe, aside {
             height: 100%;
         }
     }
     .CodeMirror-vscrollbar::-webkit-scrollbar {
         width: 6px;
         height: 6px;
         background: var(--background, #000);
     }
     .CodeMirror-vscrollbar::-webkit-scrollbar-thumb {
         background: var(--color, #aaa);
     }
     .CodeMirror-vscrollbar::-webkit-scrollbar-thumb:hover {
         background: var(--color, #aaa);
     }
     .CodeMirror-vscrollbar {
         scrollbar-color: #aaa #000;
         scrollbar-color: var(--color, #aaa) var(--background, #000);
         scrollbar-width: thin;
     }
     .config {
         position: fixed;
         bottom: 27px;
         right: 0;
         pointer-events: none;
         padding: 10px 20px;
         border-radius: 5px 0 0 0;
         color: gray;
         background: rgba(0, 0, 0, 0.5);
         font-family: sans-serif;
         text-align: right;
         z-index: 100;
     }
     .config ul {
         pointer-events: visible;
     }
     .config li {
         display: block;
         margin: 5px;
     }
     .config button {
         width: 100%;
     }
     .errors {
         color: white;
         position: absolute;
         bottom: 0;
         right: 0;
         left: 0;
         z-index: 200;
     }
     .errors ul:not(:empty) {
         margin: 10px;
     }
     .errors li {
         position: relative;
         background: #CA1919;
         font-family: monospace;
         padding: 5px 20px 5px 10px;
         margin: 5px 0;
         box-shadow: 1px 2px 11px 2px rgba(0,0,0,0.42);
     }
     .errors .message {
         white-space: pre-wrap;
     }
     .errors .close {
         cursor: pointer;
         position: absolute;
         top: 5px;
         right: 5px;
         background: black;
         width: 16px;
         height: 16px;
         line-height: 14px;
         font-size: 16px;
         display: flex;
         justify-content: center;
         align-items: center;
         border-radius: 50%;
     }
     .btn {
         box-shadow:inset 0px -3px 7px 0px #29bbff;
         background:linear-gradient(to bottom, #2dabf9 5%, #0688fa 100%);
         background-color:#2dabf9;
         border-radius:3px;
         border:1px solid #0b0e07;
         display:inline-block;
         cursor:pointer;
         color:#ffffff;
         font-family:Arial;
         font-size:15px;
         padding:9px 23px;
         text-decoration:none;
         text-shadow:0px 1px 0px #263666;
     }
     .btn:hover {
         background:linear-gradient(to bottom, #0688fa 5%, #2dabf9 100%);
         background-color:#0688fa;
     }
     .btn:active {
         position:relative;
         top:1px;
     }
     footer {
         padding: 5px 0;
         font-family: monospace;
         text-align: center;
         background: var(--background, #000);
         color: var(--color, #ccc);
         border-top: 2px solid grey;
     }
     footer p {
         margin: 0;
     }
     footer  a[href] {
         color: #3377FF;
         color: var(--link-color, #3377FF);
         cursor: pointer;
     }
     footer  a[href]:hover {
         background-color: #3377FF;
         background-color: var(--link-color, #3377FF) !important;
         color: #000;
         color: var(--background, #000) !important;
         text-decoration: none;
     }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/combine/npm/codemirror@5.x.x/addon/search/search.js,npm/codemirror@5.x.x/addon/search/matchesonscrollbar.js,npm/codemirror@5.x.x/addon/search/searchcursor.js,npm/codemirror@5.x.x/addon/search/jump-to-line.js,npm/codemirror@5.x.x/addon/scroll/annotatescrollbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/addon/dialog/dialog.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peggy"></script>
    <script src="https://cdn.jsdelivr.net/combine/npm/codemirror@5.x.x/mode/javascript/javascript.js,npm/codemirror@5.x.x/mode/pegjs/pegjs.js,npm/codemirror@5.x.x/mode/css/css.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/gaiman@master/src/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.splitter"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/static/js/idb-keyval.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/gaiman@master/umd.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
<main>
  <div class="tabs">
    <ul>
      <li class="active"><a href="#">Preview</a></li>
      <li class="hidden dev"><a href="#">Code</a></li>
      <li class="hidden dev"><a href="#">AST</a></li>
    </ul>
    <div class="content">
      <iframe class="active" id="frame" src="./demo/"></iframe>
      <div class="output editor dev"></div>
      <div class="ast editor dev"></div>
    </div>
  </div>
  <aside class="editor_wrapper">
    <div class="tabs dev hidden">
      <ul>
        <li class="active"><a href="#">PEG (Peggy) grammar</a></li>
      </ul>
      <div class="content">
        <div class="gaiman_grammar active editor">
          <div class="errors">
            <ul></ul>
          </div>
        </div>
      </div>
    </div>
    <div class="tabs user_input">
      <ul>
        <li class="active"><a href="#">Code</a></li>
        <li><a href="#">CSS</a></li>
      </ul>
      <div class="content">
        <div class="gaiman_code editor active">
          <div class="errors">
            <ul></ul>
          </div>
        </div>
        <div class="css_editor editor"></div>
      </div>
    </div>
  </aside>
</main>
<footer>
  <p>Copyright (C) 2021 <a href="https://jakub.jankiewicz.org">Jakub T. Jankiewicz</a> - <a href="https://github.com/jcubic/gaiman">Source Code</a></p>
</footer>
<div class="config">
  <ul>
    <li class="hidden dev">
      <label for="full_output">Full Output</label>
      <input type="checkbox" id="full_output"/>
    </li>
    <li>
      <label for="developer_mode">Dev Mode</label>
      <input type="checkbox" id="developer_mode"/>
    </li>
    <li>
      <button id="reset" class="btn">Reset</button>
    </li>
    <li>
      <button id="download" class="btn">Download</button>
    </li>
  </ul>
</div>
<script type="text/x-template" id="css">:root {
    --color: #ccc;
    --background: black;
    --link-color: #3377FF;
    /* use --glow: 1; to add glow effect */
    /* available animations: terminal-bar, terminal-underline */
    --animation: terminal-blink;
    --font: monospace;
    --options: {"enabled": false}; /* JSON config for jQuery Terminal */
}</script>
<script>

 $.fn.cm_refresh = function() {
     return this.filter('.CodeMirror').each(function() {
         this.CodeMirror.refresh();
     });
 };

 // ref: https://www.freecodecamp.org/news/javascript-debounce-example/
 function debounce(func, timeout = 300) {
     let timer;
     return (...args) => {
         clearTimeout(timer);
         timer = setTimeout(() => { func.apply(this, args); }, timeout);
     };
 }

 async function hash(branch) {
     try {
         var url = `https://api.github.com/repos/jcubic/gaiman/commits?sha=${branch}`;
         var res = await fetch(url);
         var data = await res.json();
         return data[0].sha;
     } catch(e) {
         return branch;
     }
 }

 function tab_activate(li) {
     var $li = $(li);
     var index = $li.index();
     $li.addClass('active').siblings().removeClass('active');
     var $content = $li.closest('ul').next();
     var $tab = $content.children()
                        .eq(index)
                        .addClass('active');
     $tab.siblings()
         .removeClass('active');
     $tab.find('.CodeMirror').cm_refresh();
 }

 var worker;
 if ('serviceWorker' in navigator) {
     var scope = location.pathname.replace(/\/[^\/]+$/, '/');
     worker = navigator.serviceWorker.register('sw.js', {scope})
              .then(function(reg) {
                  reg.addEventListener('updatefound', function() {
                      var installing_worker = reg.installing;
                      console.log('A new service worker is being installed:',
                                  installing_worker);
                  });
                  // registration worked
                  console.log('Registration succeeded. Scope is ' + reg.scope);
              }).catch(function(error) {
                  // registration failed
                  console.log('Registration failed with ' + error);
              });
 }

 var ls = {
     get: function(name) {
         var value = localStorage.getItem(name);
         if (value) {
             return JSON.parse(value);
         }
         return value;
     },
     set: function(name, value) {
         localStorage.setItem(name, value);
     }
 };

 function fetch_text(url) {
     return fetch(url).then(res => res.text());
 }

 async function get_file(token, url) {
     let result = await idbKeyval.get(token);
     if (!result) {
         result = await fetch_text(url);
     }
     return result;
 }

 function to_json(object) {
     return JSON.stringify(object, true, 2);
 }

 function make_editor(element, code, options) {
     var $node = $(element);
     const settings = $.extend({
         value: code,
         theme: 'seti',
         lineWrapping: true,
         lineNumbers: true,
         extraKeys: { Tab: better_tab, "Alt-F": "findPersistent" },
         readOnly: true,
         indentUnit: 4,
         mode: 'javascript'
     }, options);
     return CodeMirror($node.get(0), settings);
 }

 function error(editor, message) {
     var $editor = $(editor);
     var ul = $editor.find('.errors ul');
     var found = ul.find('> li').filter(function() {
         return $(this).data('message') === message;
     });
     if (!found.length) {
         var $li = $(`<li>
              <span class="message">${message}</span>
              <span class="close">&times;</span>
           </li>`).data('message', message);
         $li.appendTo(ul)
     }
 }

 function clear_error(editor) {
     var $editor = $(editor);
     $editor.find('.errors ul').empty();
 }

 function parse_error(code, e) {
     if (!code) {
         clear_error('.gaiman_code');
     } else {
         error('.gaiman_code', format_error(code, e));
     }
 }

 function format_error(code, e) {
     const output = ['Parse Error: ' + e.message, ''];
     if (e.location) {
         try {
             output.push('Error in line ' + e.location.start.line);
             const lines = code.split('\n');
             const line_number = e.location.start.line - 1;
             output.push(lines[line_number]);
             output.push(mark_error_char(e.location));
         } catch (e) {
             // ignore errors in print
         }
     }
     return output.join('\n');
 }

 function better_tab(cm) {
     if (cm.somethingSelected()) {
         cm.indentSelection("add");
     } else {
         var spaces = Array(cm.getOption("indentUnit") + 1).join(" ");
         cm.replaceSelection(
             cm.getOption("indentWithTabs")? "\t" : spaces,
             "end",
             "+input"
         );
     }
 }

 function update_editor(cm, code) {
     const { left, top } = cm.getScrollInfo();
     cm.setValue(code);
     cm.scrollTo(left, top);
 }

 function download(blob, filename) {
     const url = URL.createObjectURL(blob);
     const $li = $(`<a href="${url}" download="${filename}">download</a>`).hide();
     $li.appendTo('body');
     $li[0].click();
     $li.removee();
     URL.revokeObjectURL(url);
 }

 (async function($) {
     const has_worker = !!worker;
     if (has_worker) {
         frame.src = 'about:blank'
     }
     await worker;
     const media_query = 'screen and (max-width: 900px)';
     const small = matchMedia(media_query).matches
     const orientation = small ? 'horizontal' : 'vertical';
     $('main').split({
         orientation
     });
     let editor_splitter;
     $('.tabs').on('click', 'li', function() {
         var self = $(this);
         tab_activate(this);
         return false;
     });
     var $dev_toggle = $('#developer_mode').on('change', function() {
         toggle_dev_mode(this.checked);
     });
     var $full_mode_toggle = $('#full_output').on('change', function() {
         toggle_full_output_mode(this.checked);
     });
     $('.errors').on('click', '.close', function() {
         $(this).closest('li').remove();
     });
     $('#reset').on('click', async function() {
         parse = (code) => gaiman.parse(code);
         grammar = await fetch_text(`${repo}src/grammar.peg`);
         code = await fetch_text(`${repo}examples/hello.gs`);
         update_editor(state.editors.grammar, grammar);
         update_editor(state.editors.css, css.innerHTML);
         update_editor(state.editors.input, code);
         return false;
     });
     $('#download').on('click', function() {
         var zip = new JSZip();
         var game = zip.folder("gaiman");
         game.file("index.js", state.output_full);
         game.file("index.html", html);
         zip.generateAsync({ type:"blob" }).then(function(content) {
             download(content, "gaiman.zip");
         });
     });

     const { get, set } = idbKeyval;

     const DEV_MODE = 'gaiman__dev__mode';
     const FULL_MODE = 'gaiman__full_output';
     const SELECTED_TAB = 'gaiman__selected_tab';
     const SOURCE_FILE = '_gaiman_source.gs';
     const GRAMMAR_FILE = '_gaiman_grammar.peg';
     const OUTPUT_FILE = '_gaiman_output.js';
     const CSS_FILE = '_gaiman.css';
     const HTML_FILE = '_gaiman.html';

     const REF = await hash('master');
     const repo = `https://cdn.jsdelivr.net/gh/jcubic/gaiman@${REF}/`
     const state = {
         dev_mode: ls.get(DEV_MODE),
         selected_tab: ls.get(SELECTED_TAB),
         full_output_mode: ls.get(FULL_MODE),
         css: (await get(CSS_FILE)) || css.innerHTML,
         editors: {},
         grammar: await get_file(GRAMMAR_FILE, `${repo}src/grammar.peg`),
         code: await get_file(SOURCE_FILE, `${repo}examples/hello.gs`),
         ast: {}
     };
     window.state = state;

     const html = add_version(await fetch_text(`${repo}src/terminal.html`));
     const prefix = add_version(await fetch_text(`${repo}src/prefix.js`));
     const postfix = await fetch_text(`${repo}src/postfix.js`);

     let parse = (code) => gaiman.parse(code);

     state.editors.input = make_editor('.gaiman_code', state.code, {
         readOnly: !has_worker,
         mode: 'gaiman'
     });
     make_parser();
     compile();
     state.editors.output = make_editor('.output', state.output);
     state.editors.ast = make_editor('.ast', to_json(state.ast || {}));
     state.editors.grammar = make_editor('.gaiman_grammar', state.grammar, {
         readOnly: false,
         mode: 'pegjs'
     });
     state.editors.css = make_editor('.css_editor', state.css, {
         readOnly: false,
         mode: 'css'
     });
     build_html();
     set_idb();
     load();
     state.editors.input.on('change', debounce(update, 800));
     state.editors.grammar.on('change', debounce(function() {
         if (state.dev_mode) {
             state.grammar = state.editors.grammar.getValue();
             clear_error('.gaiman_grammar');
             try {
                 make_parser();
                 update();
             } catch(e) {
                 parse = null;
                 error('.gaiman_grammar', e.message);
                 set(GRAMMAR_FILE, state.grammar);
             }
         }
     }, 800));
     state.editors.css.on('change', debounce(function() {
         build_html();
         set(CSS_FILE, state.css);
         set(HTML_FILE, state.html);
         frame.src = `./__idb__/${HTML_FILE}`;
     }, 800));

     if (state.dev_mode !== undefined) {
         toggle_dev_mode(state.dev_mode);
         $dev_toggle.prop('checked', state.dev_mode);
         if (state.full_output_mode !== undefined) {
             toggle_full_output_mode(state.full_output_mode);
             $full_mode_toggle.prop('checked', state.full_output_mode);
         }
     }

     function make_parser() {
         if (state.dev_mode) {
             const parser = peggy.generate(state.grammar);
             parse = (code) => parser.parse(code);
         }
     }

     function toggle_dev_mode(enable) {
         state.dev_mode = enable;
         ls.set(DEV_MODE, state.dev_mode);
         $('.dev').toggleClass('hidden', !state.dev_mode);
         if (enable) {
             if (!editor_splitter) {
                 editor_splitter = $('.editor_wrapper').split({
                     orientation: 'horizontal'
                 });
             }
         } else if (editor_splitter) {
             editor_splitter.destroy();
             editor_splitter = null;
             tab_activate($('.tabs li:not(.dev):eq(0)'));
         }
         $('.editor_wrapper .CodeMirror').cm_refresh();
     }

     function toggle_full_output_mode(enable) {
         state.full_output_mode = enable;
         const { full_output_mode, output_full, output } = state;
         ls.set(FULL_MODE, full_output_mode);
         update_editor(state.editors.output, full_output_mode ? output_full : output);
     }

     function update_code() {
         state.output_full = prefix + state.output + postfix;
     }

     function template(string, mapping) {
         Object.entries(mapping).forEach(([key, value]) => {
             string = string.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), value);
         });
         return string;
     }

     function add_version(code) {
         return template(code, { VER: gaiman.version });
     }

     function compile() {
         state.code = state.editors.input.getValue();
         parse_error();
         try {
             if (parse) {
                 state.ast = parse(state.code);
                 state.output = gaiman.generate(state.ast);
                 update_code();
             }
         } catch(e) {
             state.output = '';
             parse_error(state.code, e);
         }
     }

     function set_idb() {
         set(SOURCE_FILE, state.code);
         set(HTML_FILE, state.html);
         set(OUTPUT_FILE, state.output_full);
         set(GRAMMAR_FILE, state.grammar);
     }
     function build_html() {
         state.css = state.editors.css.getValue();
         state.html = template(html, { STYLE: state.css, FILE: './_gaiman_output.js' });
     }

     function update() {
         build_html();
         compile();
         set_idb();
         load();
     }

     function load() {
         if (has_worker && state.output) {
             frame.src = `./__idb__/${HTML_FILE}`;
             if (state.full_output) {
                 update_editor(state.editors.output, state.output_full);
             } else {
                 update_editor(state.editors.output, state.output);
             }
             update_editor(state.editors.ast, to_json(state.ast || {}));
         }
     }
 })(jQuery);
</script>
<script defer async src="https://cdn.jsdelivr.net/npm/jszip"></script>
</body>
</html>
