<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Gaiman Engine Demo</title>
    <meta name="Description" content="Demo of the Gaiman DSL programming language"/>
    <link rel="shortcut icon" href=""/>
    <!--[if IE]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://cdn.jsdelivr.net/npm/jquery.splitter/css/jquery.splitter.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/lib/codemirror.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/theme/seti.css" rel="stylesheet"/>
    <style>
     body {
         margin: 0;
     }
     main {
         height: 100vh;
     }
     iframe {
         border: none;
         display: block;
     }
     .CodeMirror {
         height: 100%;
     }
     .editor, iframe {
         width: 100%;
         height: 100%;
     }
     .hidden {
         display: none !important;
     }
     :root {
         --tab-bg: #1d1e22;
         --tab-color: #aaaebc;
         --tab-border-color: #34363e;
         --tab-color-active: #1236f7;
     }
     .tabs > ul {
         list-style: none;
         margin: 0;
         padding: 5px 10px 0 5px;
         background: black;
         font-family: sans-serif;
         border-bottom: 2px solid grey
     }
     .tabs > ul li {
         background: var(--tab-bg);
         color: var(--tab-color);
         border-top: 3px solid var(--tab-border-color);
         border-radius: 3px 3px 0 0;
         display: inline-block;
     }
     .tabs > .content > :not(.active) {
         display: none;
     }
     .tabs > .content {
         height: calc(100% - 40px);
     }
     .tabs > ul li.active {
         border-top-color: var(--tab-color-active);
         margin-bottom: -2px;
         padding-bottom: 2px;
     }
     .tabs > ul li a, .tabs > ul li a:hover {
         color: inherit;
         display: block;
         padding: 6px 18px;
         text-decoration: none;
     }
     @media screen and (min-width: 900px) {
         iframe, aside {
             height: 100%;
         }
     }
     .CodeMirror-vscrollbar::-webkit-scrollbar {
         width: 6px;
         height: 6px;
         background: var(--background, #000);
     }
     .CodeMirror-vscrollbar::-webkit-scrollbar-thumb {
         background: var(--color, #aaa);
     }
     .CodeMirror-vscrollbar::-webkit-scrollbar-thumb:hover {
         background: var(--color, #aaa);
     }
     .CodeMirror-vscrollbar {
         scrollbar-color: #aaa #000;
         scrollbar-color: var(--color, #aaa) var(--background, #000);
         scrollbar-width: thin;
     }
     .config {
         position: fixed;
         bottom: 0;
         right: 0;
         padding: 10px 20px;
         color: gray;
         background: black;
     }
     .errors {
         color: white;
         position: absolute;
         bottom: 0;
         right: 0;
         left: 0;
         margin: 10px;
         z-index: 100;
     }
     .errors ul {
         list-style: none;
         margin: 0;
         padding: 0;
     }
     .errors li {
         position: relative;
         background: #CA1919;
         font-family: monospace;
         padding: 5px 20px 5px 10px;
         margin: 5px 0;
         box-shadow: 1px 2px 11px 2px rgba(0,0,0,0.42);
     }
     .errors .message {
         white-space: pre-wrap;
     }
     .errors .close {
         cursor: pointer;
         position: absolute;
         top: 5px;
         right: 5px;
         background: black;
         width: 16px;
         height: 16px;
         line-height: 14px;
         font-size: 16px;
         display: flex;
         justify-content: center;
         align-items: center;
         border-radius: 50%;
     }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/peggy"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/mode/javascript/javascript.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.x.x/mode/pegjs/pegjs.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/gaiman@master/src/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.splitter"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/static/js/idb-keyval.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jcubic/gaiman@master/umd.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
<main>
  <div class="tabs">
    <ul>
      <li class="active"><a href="#">Preview</a></li>
      <li class="hidden dev"><a href="#">&lt;code&gt;</a></li>
      <li class="hidden dev"><a href="#">AST</a></li>
    </ul>
    <div class="content">
      <iframe class="active" id="frame" src="./demo/"></iframe>
      <div class="output editor dev"></div>
      <div class="ast editor dev"></div>
    </div>
  </div>
  <aside class="editor_wrapper">
    <div class="gaiman_grammar editor dev hidden">
      <div class="errors">
        <ul></ul>
      </div>
    </div>
    <div class="gaiman_code editor">
      <div class="errors">
        <ul></ul>
      </div>
    </div>
  </aside>
</main>
<div class="config">
  <label for="developer_mode">Dev Mode</label>
  <input type="checkbox" id="developer_mode"/>
</div>
<a href="https://github.com/jcubic/gaiman" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; z-index: 10; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<script>
 // ref: https://www.freecodecamp.org/news/javascript-debounce-example/
 function debounce(func, timeout = 300) {
     let timer;
     return (...args) => {
         clearTimeout(timer);
         timer = setTimeout(() => { func.apply(this, args); }, timeout);
     };
 }
 async function hash(branch) {
     try {
         var url = `https://api.github.com/repos/jcubic/gaiman/commits?sha=${branch}`;
         var res = await fetch(url);
         var data = await res.json();
         return data[0].sha;
     } catch(e) {
         return branch;
     }
 }
 function tab_activate(li) {
     var $li = $(li);
     var index = $li.index();
     $li.addClass('active').siblings().removeClass('active');
     var $content = $li.closest('ul').next();
     var $tab = $content.children()
                        .eq(index)
                        .addClass('active');
     $tab.siblings()
         .removeClass('active');
     var $cm = $tab.find('.CodeMirror');
     if ($cm.length) {
         $cm.get(0).CodeMirror.refresh();
     }
 }
 var worker;
 if ('serviceWorker' in navigator) {
     var scope = location.pathname.replace(/\/[^\/]+$/, '/');
     worker = navigator.serviceWorker.register('sw.js', {scope})
              .then(function(reg) {
                  reg.addEventListener('updatefound', function() {
                      var installing_worker = reg.installing;
                      console.log('A new service worker is being installed:',
                                  installing_worker);
                  });
                  // registration worked
                  console.log('Registration succeeded. Scope is ' + reg.scope);
              }).catch(function(error) {
                  // registration failed
                  console.log('Registration failed with ' + error);
              });
 }
 var ls = {
     get: function(name) {
         var value = localStorage.getItem(name);
         if (value) {
             return JSON.parse(value);
         }
         return value;
     },
     set: function(name, value) {
         localStorage.setItem(name, value);
     }
 };
 function fetch_text(url) {
     return fetch(url).then(res => res.text());
 }
 async function get_file(token, url) {
     let result = await idbKeyval.get(token);
     if (!result) {
         result = await fetch_text(url);
     }
     return result;
 }
 function to_json(object) {
     return JSON.stringify(object, true, 2);
 }
 function make_editor(element, code, options) {
     var $node = $(element);
     const settings = $.extend({
         value: code,
         theme: 'seti',
         lineWrapping: true,
         lineNumbers: true,
         readOnly: true,
         indentUnit: 4,
         mode: 'javascript'
     }, options);
     return CodeMirror($node.get(0), settings);
 }
 function error(editor, message) {
     var $editor = $(editor);
     var ul = $editor.find('.errors ul');
     var found = ul.find('> li').filter(function() {
         return $(this).data('message') === message;
     });
     if (!found.length) {
         var $li = $(`<li>
              <span class="message">${message}</span>
              <span class="close">&times;</span>
           </li>`).data('message', message);
         $li.appendTo(ul)
     }
 }
 function clear_error(editor) {
     var $editor = $(editor);
     $editor.find('.errors ul').empty();
 }
 function parse_error(code, e) {
     if (!code) {
         clear_error('.gaiman_code');
     } else {
         error('.gaiman_code', format_error(code, e));
     }
 }
 function format_error(code, e) {
     const output = ['Parse Error: ' + e.message, ''];
     if (e.location) {
         try {
             output.push('Error in line ' + e.location.start.line);
             const lines = code.split('\n');
             const line_number = e.location.start.line - 1;
             output.push(lines[line_number]);
             output.push(mark_error_char(e.location));
         } catch (e) {
             // ignore errors in print
         }
     }
     return output.join('\n');
 }
 (async function($) {
     const has_worker = !!worker;
     if (has_worker) {
         frame.src = 'about:blank'
     }
     await worker;
     const media_query = 'screen and (max-width: 900px)';
     const small = matchMedia(media_query).matches
     const orientation = small ? 'horizontal' : 'vertical';
     $('main').split({
         orientation
     });
     let editor_splitter;
     $('.tabs').on('click', 'li', function() {
         var self = $(this);
         tab_activate(this);
         return false;
     });
     var $dev_toggle = $('#developer_mode').on('change', function() {
         toggle_dev_mode(this.checked);
     });
     $('.errors').on('click', '.close', function() {
         $(this).closest('li').remove();
     });
     const DEV_MODE = 'gaiman__dev__mode';
     const REF = await hash('master');
     let dev_mode = ls.get(DEV_MODE);
     function toggle_dev_mode(enable) {
         dev_mode = enable;
         ls.set(DEV_MODE, dev_mode);
         $('.dev').toggleClass('hidden', !dev_mode);
         if (enable) {
             if (!editor_splitter) {
                 editor_splitter = $('.editor_wrapper').split({
                     orientation: 'horizontal'
                 });
             }
         } else if (editor_splitter) {
             editor_splitter.destroy();
             editor_splitter = null;
         }
     }
     if (dev_mode !== undefined) {
         toggle_dev_mode(dev_mode);
         $dev_toggle.prop('checked', dev_mode);
     }
     const repo = `https://cdn.jsdelivr.net/gh/jcubic/gaiman@${REF}/`
     const prefix = await fetch_text(`${repo}src/prefix.js`);
     const postfix = await fetch_text(`${repo}src/postfix.js`);
     const SOURCE_FILE = '_gaiman_source.gs';
     const GRAMMAR_FILE = '_gaiman_grammar.peg';
     const OUTPUT_FILE = '_gaiman_output.js';
     const { get, set } = idbKeyval;
     let parse = (code) => gaiman.parse(code);
     function compile(init) {
         code = editor.input.getValue();
         try {
             ast = parse(code);
             output = prefix + gaiman.generate(ast) + postfix;
             output = output.replace(/\{\{VER\}\}/g, gaiman.version);
             parse_error();
         } catch(e) {
             output = '';
             parse_error(code, e);
         }
     }
     function set_idb() {
         set(SOURCE_FILE, code);
         set(OUTPUT_FILE, output);
         set(GRAMMAR_FILE, grammar);
     }
     function update() {
         compile();
         set_idb();
         load();
     }
     function load() {
         if (has_worker && output) {
             frame.src = './gaiman.html?' + Date.now();
             editor.output.setValue(output);
             editor.ast.setValue(to_json(ast || {}));
         }
     }
     let output, ast;
     let grammar = await get_file(GRAMMAR_FILE, `${repo}src/grammar.peg`);
     let code = await get_file(SOURCE_FILE, `${repo}examples/demo.gs`);
     const editor = {};
     editor.input = make_editor('.gaiman_code', code, {
         readOnly: !has_worker,
         mode: 'gaiman'
     });
     compile();
     editor.output = make_editor('.output', output);
     editor.ast = make_editor('.ast', to_json(ast || {}));
     editor.grammar = make_editor('.gaiman_grammar', grammar, {
         readOnly: false,
         mode: 'pegjs'
     });
     set_idb();
     load();
     editor.input.on('change', debounce(update, 800));
     editor.grammar.on('change', debounce(function() {
         grammar = editor.grammar.getValue();
         try {
             const parser = peggy.generate(grammar);
             parse = (code) => parser.parse(code);
             update();
             clear_error('.gaiman_grammar');
         } catch(e) {
             error('.gaiman_grammar', e.message);
             set(GRAMMAR_FILE, grammar);
         }
     }, 800));
 })(jQuery);
</script>
</body>
</html>
